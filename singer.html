<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé§ Singer - SDkaraoke</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>üé§</text></svg>" type="image/svg+xml">
    <!-- Firebase SDK (Compat Version for legacy API) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>
    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="youtube-api.js"></script>
    <style>
        .singer-page {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container-main {
            max-width: 900px;
            margin: auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header h1 {
            color: #ffffff;
            font-weight: 700;
        }

        .header h1 .sd-text {
            font-family: 'Brush Script MT', 'Lucida Calligraphy', cursive;
            color: #f093fb;
            font-size: 1.2em;
            font-style: italic;
            text-shadow: 0 0 10px rgba(240, 147, 251, 0.6);
        }

        .card-ui {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }

        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .controls button {
            flex: 1;
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .controls button:hover {
            transform: scale(1.08);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .controls button:active {
            transform: scale(0.95);
        }

        .play { background: #22c55e; }
        .pause { background: #6b7280; }
        .stop { background: #ef4444; }
        .gray { background: #6b7280; }

        .play:hover { background: #1da850; }
        .pause:hover { background: #5a5f6b; }

        .disconnect {
            background: linear-gradient(135deg, #f5576c, #f093fb);
            border: none;
            color: white;
            padding: 10px 18px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .disconnect:hover {
            box-shadow: 0 12px 30px rgba(245, 87, 108, 0.4);
            transform: translateY(-3px);
        }

        .disconnect:active {
            transform: translateY(-1px);
        }

        .refresh {
            background: white;
            color: black;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            margin-bottom: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 44px;
        }

        .refresh:hover {
            transform: scale(1.05);
        }

        .refresh-icon {
            display: inline-block;
            transition: transform 0.3s ease;
        }

        .refresh.rotating .refresh-icon {
            animation: spinRotate 0.8s linear infinite;
        }

        @keyframes spinRotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .searchbox {
            display: flex;
            gap: 10px;
        }

        .searchbox input {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-size: 1rem;
        }

        .searchbtn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 12px 18px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .searchbtn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .searchbtn:active {
            transform: scale(0.95);
        }

        .song-item {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(240, 147, 251, 0.1));
            border: 2px solid rgba(102, 126, 234, 0.4);
            border-radius: 12px;
            padding: 0;
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .song-item:hover {
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transform: translateY(-3px);
        }

        .song-thumbnail {
            width: 100%;
            height: 150px;
            object-fit: cover;
            background: #000;
            display: block;
        }

        .song-info {
            padding: 15px;
        }

        .song-title {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 5px;
            color: white;
            line-height: 1.3;
        }

        .song-artist {
            font-size: 0.85rem;
            opacity: 0.85;
            color: #ddd;
            margin-bottom: 12px;
        }

        .song-item button {
            width: 100%;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            color: white;
            padding: 12px;
            border-radius: 0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1rem;
        }

        .song-item button:hover {
            background: linear-gradient(135deg, #16a34a, #15803d);
            opacity: 0.95;
        }

        .song-item button:active {
            transform: scale(0.98);
        }

        #resultsContainer {
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .song-thumbnail {
                height: 120px;
            }
            .song-info {
                padding: 12px;
            }
            .song-title {
                font-size: 0.95rem;
            }
            .song-artist {
                font-size: 0.8rem;
            }
        }

        .alert-custom {
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 1rem;
            border: 2px solid;
        }

        /* Footer Styles */
        .footer-section {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 50px 20px;
            margin-top: 60px;
            border-top: 2px solid rgba(102, 126, 234, 0.3);
        }

        .footer-content {
            max-width: 900px;
            margin: 0 auto;
        }

        .footer-title {
            font-size: 2rem;
            font-weight: 900;
            color: #ff6b6b;
            margin-bottom: 15px;
            font-family: 'Brush Script MT', cursive;
        }

        .footer-description {
            font-size: 0.95rem;
            line-height: 1.6;
            opacity: 0.85;
            margin-bottom: 30px;
            color: #ddd;
        }

        .footer-social {
            margin: 30px 0;
        }

        .footer-social-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #ff6b6b;
            margin-bottom: 15px;
        }

        .social-icons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .social-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(102, 126, 234, 0.2);
            border: 2px solid rgba(102, 126, 234, 0.4);
            border-radius: 50%;
            color: #667eea;
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 1.1rem;
        }

        .social-icon:hover {
            background: #667eea;
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .footer-copyright {
            font-size: 0.85rem;
            opacity: 0.7;
            text-align: center;
            padding-top: 30px;
            border-top: 1px solid rgba(102, 126, 234, 0.2);
            margin-top: 30px;
        }
    </style>
</head>
<body class="singer-page">
    <div class="container-main">
        <!-- HEADER -->
        <div class="header">
            <h1><span class="sd-text">SD</span>karaoke</h1>
            <button class="disconnect" onclick="disconnectSinger()">DISCONNECT</button>
        </div>

        <!-- PLAYER -->
        <div class="card-ui">
            <div style="margin-bottom: 15px; font-size: 18px; font-weight: 600;">Welcome</div>
            <div id="userDisplayName" style="margin-bottom: 12px; font-size: 1.3rem; font-weight: 700; color: #f093fb;">üé§ Welcome, mel!</div>
            
            <div class="refresh" onclick="reloadPlayer()"><span class="refresh-icon">üîÑ</span></div>

            <div class="controls">
                <button class="gray" id="muteBtn" onclick="toggleMute()">üîä</button>
                <button class="play" id="playPauseBtn" onclick="togglePlayPause()">‚ñ∂</button>
                <button class="stop" onclick="stopPlayer()">‚ñ†</button>
            </div>
            
            <!-- Hidden audio player for preview -->
            <audio id="audioPlayer" style="display: none;"></audio>
        </div>

        <!-- SEARCH & RESERVE -->
        <div class="card-ui">
            <h3>Search & Reserve</h3>
            <form id="searchForm">
                <div class="searchbox">
                    <input id="searchInput" placeholder="Search..." />
                    <button type="submit" class="searchbtn">üîç</button>
                </div>
            </form>
            <div id="resultsContainer"></div>
        </div>

        <!-- RESERVED -->
        <div class="card-ui">
            <h3>Reserved Songs</h3>
            <div id="reservedSongs"></div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="footer-section">
        <div class="footer-content">
            <h2 class="footer-title">üé§ SDkaraoke</h2>
            <p class="footer-description">
                Turn any screen into a karaoke machine with SDKaraoke.
            </p>

            <div class="footer-social">
                <div class="footer-social-title">Connect With Me</div>
                <div class="social-icons">
                    <a href="https://facebook.com" target="_blank" rel="noopener noreferrer" class="social-icon" title="Facebook">f</a>
                    <a href="https://twitter.com" target="_blank" rel="noopener noreferrer" class="social-icon" title="Twitter">ùïè</a>
                    <a href="https://github.com" target="_blank" rel="noopener noreferrer" class="social-icon" title="GitHub">‚öô</a>
                </div>
            </div>

            <div class="footer-copyright">
                ¬© 2025 SDkaraoke. All rights reserved. | Built with ‚ù§Ô∏è by Shan Denver
            </div>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // ===== SINGER PAGE STATE =====
        let searchResults = [];
        let audioPlayer;
        let allSongs = [];
        let reservedSongs = [];
        let useSingerFirebase = false;
        let suppressAudioErrors = false; // Flag to suppress expected audio errors
        let loggedInUser = null; // Store logged-in user globally

        // Check if user is logged in
        function checkSingerLogin() {
            const stored = localStorage.getItem('karaoke_logged_in_user');
            if (!stored) {
                window.location.href = 'index.html';
                return false;
            }
            loggedInUser = JSON.parse(stored);
            return true;
        }

        // Check if Firebase is properly configured
        function isSingerFirebaseConfigured() {
            try {
                if (typeof firebase !== 'undefined' && firebase.database && firebase.app()) {
                    const config = firebase.app().options;
                    return config.databaseURL && !config.databaseURL.includes('YOUR_');
                }
            } catch (e) {
                return false;
            }
            return false;
        }

        // Initialize page on load
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkSingerLogin()) return;

            console.log('üé§ Singer page loaded');
            
            // Initialize Firebase check
            useSingerFirebase = isSingerFirebaseConfigured();
            console.log('Firebase available:', useSingerFirebase);

            // Initialize singer page
            audioPlayer = document.getElementById('audioPlayer');
            
            // Update activity timestamp for TV display connection status AND user database
            function updateActivityTimestamp() {
                const now = Date.now();
                localStorage.setItem('karaoke_singer_activity', now.toString());
                
                // Update the activity timestamp in Firebase for TV display connection detection
                if (useSingerFirebase && typeof firebase !== 'undefined' && firebase.database) {
                    try {
                        firebase.database().ref('activity').update({
                            timestamp: now
                        }).catch(err => console.warn('Firebase activity update failed:', err.message));
                    } catch (fbErr) {
                        // Firebase error, continue without it
                    }
                }
                
                // Also update the user's lastActivity in the database
                if (loggedInUser) {
                    try {
                        // Update lastActivity in localStorage
                        loggedInUser.lastActivity = now;
                        localStorage.setItem('karaoke_logged_in_user', JSON.stringify(loggedInUser));
                        
                        // Update in Firebase if available
                        if (useSingerFirebase && typeof firebase !== 'undefined' && firebase.database) {
                            try {
                                firebase.database().ref('users/' + loggedInUser.id).update({
                                    lastActivity: now
                                }).catch(err => console.warn('Firebase user update failed:', err.message));
                            } catch (fbErr) {
                                // Firebase error, continue without it
                            }
                        }
                    } catch (e) {
                        console.warn('Error updating user activity:', e.message);
                    }
                }
                console.log('üé§ Singer activity updated:', new Date().toLocaleTimeString());
            }
            
            // Update timestamp on page load
            console.log('üé§ Singer page loaded - setting initial activity timestamp');
            
            // Ensure user has an ID if not already set
            if (loggedInUser && !loggedInUser.id) {
                loggedInUser.id = 'singer_' + Date.now();
                localStorage.setItem('karaoke_logged_in_user', JSON.stringify(loggedInUser));
                console.log('üÜî Assigned ID to user:', loggedInUser.id);
            }
            
            updateActivityTimestamp();
            
            // Update timestamp every 5 seconds while page is open (faster updates)
            const activityInterval = setInterval(updateActivityTimestamp, 5000);
            console.log('‚è±Ô∏è Activity timer started');
            
            // Update timestamp on user interactions
            const updateOnClick = () => updateActivityTimestamp();
            const updateOnKey = () => updateActivityTimestamp();
            const updateOnInput = () => updateActivityTimestamp();
            
            document.addEventListener('click', updateOnClick);
            document.addEventListener('keypress', updateOnKey);
            document.addEventListener('input', updateOnInput);
            console.log('üì° Activity listeners registered');
            
            if (!audioPlayer) {
                console.error('‚ùå Audio player element not found!');
            } else {
                console.log('‚úÖ Audio player initialized');
                // Set up audio event listeners
                audioPlayer.addEventListener('ended', function() {
                    console.log('üîö Song ended');
                    const btn = document.getElementById('playPauseBtn');
                    if (btn) {
                        btn.textContent = '‚ñ∂';
                        btn.classList.remove('play');
                        btn.classList.add('pause');
                    }
                });
                audioPlayer.addEventListener('error', function(e) {
                    // Suppress errors when we intentionally remove the audio source
                    if (suppressAudioErrors) {
                        return;
                    }
                    
                    // Only log error if there's an actual source set
                    // Empty/missing src is intentional for YouTube videos
                    if (e.target.src && e.target.src.length > 0) {
                        const errorCodes = {
                            1: 'MEDIA_ERR_ABORTED',
                            2: 'MEDIA_ERR_NETWORK',
                            3: 'MEDIA_ERR_DECODE',
                            4: 'MEDIA_ERR_SRC_NOT_SUPPORTED'
                        };
                        const errorType = errorCodes[e.target.error?.code] || 'UNKNOWN_ERROR';
                        console.warn('‚ö†Ô∏è Audio error:', errorType, '(Code:', e.target.error?.code, ')');
                    }
                });
            }
            
            // Populate singer name display
            if (loggedInUser) {
                const userDisplayName = document.getElementById('userDisplayName');
                if (userDisplayName) {
                    userDisplayName.textContent = `üé§ Welcome, ${loggedInUser.username}!`;
                    userDisplayName.style.color = '#f093fb';
                }
                localStorage.setItem('karaoke_user_name', loggedInUser.username);
            }
            
            const searchForm = document.getElementById('searchForm');
            if (searchForm) {
                searchForm.removeEventListener('submit', handleSearch);
                searchForm.addEventListener('submit', handleSearch);
            }
            
            // Initialize page data
            loadAllSongs();
            loadReservedSongs();
            displayReservedSongs();
            updateUserDisplay();
            updateSingerActivity();
            
            // Listen for Firebase queue updates if available
            if (useSingerFirebase && typeof firebase !== 'undefined' && firebase.database) {
                try {
                    firebase.database().ref('queue').on('value', (snapshot) => {
                        const data = snapshot.val();
                        console.log('üî• Firebase queue snapshot:', data);
                        if (data) {
                            // Convert Firebase object to array if needed
                            let queueArray = Array.isArray(data) ? data : Object.values(data);
                            console.log('üìä Converted queue array length:', queueArray.length, queueArray);
                            localStorage.setItem('karaoke_queue', JSON.stringify(queueArray));
                            
                            // Update reserved songs display from Firebase data
                            const reservedArray = queueArray.map(song => ({ 
                                title: song.title, 
                                artist: song.artist, 
                                videoId: song.videoId,
                                requestedBy: song.requestedBy
                            }));
                            console.log('üìã Reserved array length:', reservedArray.length, reservedArray);
                            reservedSongs = reservedArray;
                            localStorage.setItem('karaoke_reserved_songs', JSON.stringify(reservedArray));
                            displayReservedSongs();
                            
                            console.log('üì° Queue synced from Firebase:', queueArray.length, 'songs');
                        } else {
                            // Queue is empty - clear all reserved songs
                            console.log('‚ö™ Firebase queue is empty - clearing reserved songs');
                            reservedSongs = [];
                            localStorage.setItem('karaoke_queue', JSON.stringify([]));
                            localStorage.setItem('karaoke_reserved_songs', JSON.stringify([]));
                            displayReservedSongs();
                            
                            // Clear search results too
                            const searchResultsDiv = document.getElementById('searchResults');
                            if (searchResultsDiv) {
                                searchResultsDiv.innerHTML = '';
                            }
                            console.log('üóëÔ∏è All reserved songs and search results cleared');
                        }
                    });
                } catch (fbError) {
                    console.warn('‚ö†Ô∏è Could not set Firebase listener:', fbError.message);
                }
            }
            
            // Listen for localStorage changes from TV display
            window.addEventListener('storage', function(e) {
                if (e.key === 'karaoke_queue') {
                    console.log('üì° Queue updated from TV display');
                    loadReservedSongs();
                    displayReservedSongs();
                }
            });
            
            // Auto-refresh activity every 30 seconds
            setInterval(updateSingerActivity, 30000);
            
            console.log('‚úÖ Singer page initialized successfully');
        });

        // Disconnect singer
        function disconnectSinger() {
            if (confirm('Are you sure you want to disconnect?')) {
                localStorage.removeItem('karaoke_logged_in_user');
                window.location.href = 'index.html';
            }
        }

        // ===== SINGER PAGE FUNCTIONS =====

        // Handle search form submission
        async function handleSearch(e) {
            e.preventDefault();
            
            const searchInput = document.getElementById('searchInput');
            const searchQuery = searchInput ? searchInput.value.trim() : '';
            
            if (!searchQuery) {
                alert('Please enter a song name');
                return;
            }

            const searchBtn = document.querySelector('#searchForm .searchbtn');
            if (searchBtn) {
                searchBtn.disabled = true;
                searchBtn.textContent = '‚è≥ Searching...';
            }

            try {
                searchResults = await performSearch(searchQuery);
                const userName = loggedInUser ? loggedInUser.username : 'Guest';
                displaySearchResults(searchResults, userName);
            } catch (error) {
                console.error('Search error:', error);
                showAlert('Error searching for songs. Please try again.', 'danger');
            } finally {
                if (searchBtn) {
                    searchBtn.disabled = false;
                    searchBtn.textContent = 'üîç Search';
                }
            }
        }

        // YouTube API search function
        async function performSearch(query) {
            try {
                const results = await searchYouTubeKaraoke(query);
                return results.map(item => ({
                    title: item.title,
                    artist: item.artist,
                    videoId: item.videoId,
                    thumbnail: item.thumbnail
                }));
            } catch (error) {
                console.error('YouTube API Error:', error);
                return getFallbackSongs(query);
            }
        }

        // Fallback demo data
        function getFallbackSongs(query) {
            const allSongs = [
                { title: "Bohemian Rhapsody - Karaoke", artist: "Queen", videoId: "fJ9rUzIMt7o" },
                { title: "Hallelujah - Karaoke", artist: "Leonard Cohen", videoId: "YAHxj0k0WL0" },
                { title: "Someone Like You - Karaoke", artist: "Adele", videoId: "hHUbLv4ThOk" },
                { title: "Perfect - Karaoke", artist: "Ed Sheeran", videoId: "2takcwFERG0" },
                { title: "Shape of You - Karaoke", artist: "Ed Sheeran", videoId: "JGwWNGJdvx8" },
                { title: "Rolling in the Deep - Karaoke", artist: "Adele", videoId: "rYEDA3JcQqw" },
                { title: "Imagine - Karaoke", artist: "John Lennon", videoId: "DVg2EJvvlF8" },
                { title: "Wonderwall - Karaoke", artist: "Oasis", videoId: "6hzrDeceEKc" },
                { title: "Piano Man - Karaoke", artist: "Billy Joel", videoId: "1vrEljMfXWc" },
                { title: "Don't Stop Believin' - Karaoke", artist: "Journey", videoId: "1k8craCGpgs" }
            ];
            return allSongs.filter(song => 
                song.title.toLowerCase().includes(query.toLowerCase()) ||
                song.artist.toLowerCase().includes(query.toLowerCase())
            );
        }

        // Display search results
        function displaySearchResults(results, userName) {
            const container = document.getElementById('resultsContainer');

            if (results.length === 0) {
                const searchInput = document.getElementById('searchInput');
                const query = searchInput ? searchInput.value : '';
                container.innerHTML = `<div class="alert alert-custom">‚ùå No results found for "${query}"</div>`;
                return;
            }

            let html = `<h3 style="color: white; margin-bottom: 1rem; font-size: 1.3rem; font-weight: 600;">üìå Results (${results.length})</h3>`;

            results.forEach((song) => {
                const thumbnailUrl = `https://i.ytimg.com/vi/${song.videoId}/hqdefault.jpg`;
                html += `
                    <div class="song-item">
                        <img src="${thumbnailUrl}" alt="${song.title}" class="song-thumbnail" onerror="this.src='https://via.placeholder.com/320x180?text=Song+Thumbnail'">
                        <div class="song-info">
                            <div class="song-title">${song.title}</div>
                            <div class="song-artist">üé§ ${song.artist}</div>
                            <button class="song-item-btn" onclick="requestSong('${song.title.replace(/'/g, "\\'")}', '${song.artist.replace(/'/g, "\\'")}', '${song.videoId}', '${userName}', this)">
                                Reserve
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Request song
        function requestSong(title, artist, videoId, userName, btn) {
            if (!userName.trim()) {
                alert('Please enter your name first');
                return;
            }

            btn.disabled = true;
            btn.textContent = '‚è≥ Adding...';

            try {
                const newSong = {
                    id: Date.now().toString(),
                    title,
                    artist,
                    videoId,
                    requestedBy: userName,
                    timestamp: new Date().toLocaleString()
                };

                // Mark that this song is being sung (for scoring system)
                if (typeof markSinging !== 'undefined') {
                    try {
                        markSinging();
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Could not mark singing activity:', e.message);
                    }
                }

                // Write to Firebase first (primary method)
                if (useSingerFirebase && typeof firebase !== 'undefined' && firebase.database) {
                    try {
                        // Load current queue from localStorage
                        let queue = JSON.parse(localStorage.getItem('karaoke_queue') || '[]');
                        queue.push(newSong);
                        
                        // Save entire queue to Firebase (replaces old approach of individual songs)
                        firebase.database().ref('queue').set(queue).then(() => {
                            console.log('‚úÖ Song added to Firebase queue:', newSong.title);
                            addToLocalQueue(newSong);
                            setCurrentSongAndAutoPlay(newSong);
                            successCallback(btn, title);
                        }).catch(err => {
                            console.warn('Firebase write failed:', err.message);
                            // Fallback to localStorage
                            addToLocalQueue(newSong);
                            setCurrentSongAndAutoPlay(newSong);
                            successCallback(btn, title);
                        });
                    } catch (fbError) {
                        console.warn('Firebase error:', fbError.message);
                        addToLocalQueue(newSong);
                        setCurrentSongAndAutoPlay(newSong);
                        successCallback(btn, title);
                    }
                } else {
                    // Fallback to localStorage
                    addToLocalQueue(newSong);
                    setCurrentSongAndAutoPlay(newSong);
                    successCallback(btn, title);
                }

            } catch (error) {
                console.error('Error requesting song:', error);
                showAlert('Error adding song', 'danger');
                btn.disabled = false;
                btn.textContent = '‚úì Select';
            }
        }

        // Helper function to add song to local queue
        function addToLocalQueue(song) {
            let queue = JSON.parse(localStorage.getItem('karaoke_queue') || '[]');
            // Only add if not already added by the calling function
            if (!queue.some(s => s.id === song.id)) {
                queue.push(song);
                localStorage.setItem('karaoke_queue', JSON.stringify(queue));
                console.log('‚úÖ Song added to local queue. Queue length:', queue.length);

                // Also add to reserved songs display - only if not duplicate
                const reservedSong = { 
                    title: song.title, 
                    artist: song.artist, 
                    videoId: song.videoId,
                    requestedBy: song.requestedBy
                };
                
                // Check if already in reserved songs
                if (!reservedSongs.some(s => s.videoId === song.videoId && s.requestedBy === song.requestedBy)) {
                    reservedSongs.push(reservedSong);
                    localStorage.setItem('karaoke_reserved_songs', JSON.stringify(reservedSongs));
                    displayReservedSongs();
                } else {
                    console.warn('‚ö†Ô∏è Song already in reserved list - duplicate prevented');
                }
            } else {
                console.warn('‚ö†Ô∏è Song already exists in queue - duplicate prevented');
            }

            // Notify TV display of queue update
            window.dispatchEvent(new CustomEvent('karaoke-queue-updated', { 
                detail: { song, queue } 
            }));
            
            console.log('üì§ Dispatched karaoke-queue-updated event');
        }

        // Set current song and trigger auto-play
        function setCurrentSongAndAutoPlay(song) {
            // Only set as current song if no current song exists in Firebase
            // Otherwise, just add to queue - TV display will auto-play when ready
            
            if (useSingerFirebase && typeof firebase !== 'undefined' && firebase.database) {
                try {
                    firebase.database().ref('currentSong').once('value', (snapshot) => {
                        const firebaseCurrentSong = snapshot.val();
                        
                        if (!firebaseCurrentSong || !firebaseCurrentSong.videoId) {
                            // No current song playing in Firebase - set this as current
                            const newCurrentSong = {
                                title: song.title,
                                artist: song.artist,
                                videoId: song.videoId,
                                requestedBy: song.requestedBy,
                                singer: song.requestedBy,
                                timestamp: Date.now()
                            };
                            
                            firebase.database().ref('currentSong').set(newCurrentSong);
                            localStorage.setItem('karaoke_current_song', JSON.stringify(newCurrentSong));
                            console.log('‚úÖ Current song set (no song playing):', song.title);
                        } else {
                            // Song already playing in Firebase - don't interrupt
                            console.log('‚úÖ Song added to queue (not interrupting):', song.title, '| Currently playing:', firebaseCurrentSong.title);
                        }
                    });
                } catch (fbError) {
                    // Fallback to localStorage if Firebase fails
                    let currentSongData = JSON.parse(localStorage.getItem('karaoke_current_song') || 'null');
                    if (!currentSongData || !currentSongData.videoId) {
                        const currentSong = {
                            title: song.title,
                            artist: song.artist,
                            videoId: song.videoId,
                            requestedBy: song.requestedBy,
                            singer: song.requestedBy
                        };
                        localStorage.setItem('karaoke_current_song', JSON.stringify(currentSong));
                        console.log('‚úÖ Current song set in localStorage (Firebase unavailable):', song.title);
                    } else {
                        console.log('‚úÖ Song added to queue (localStorage check):', song.title);
                    }
                }
            } else {
                // Fallback to localStorage
                let currentSongData = JSON.parse(localStorage.getItem('karaoke_current_song') || 'null');
                if (!currentSongData || !currentSongData.videoId) {
                    const currentSong = {
                        title: song.title,
                        artist: song.artist,
                        videoId: song.videoId,
                        requestedBy: song.requestedBy,
                        singer: song.requestedBy
                    };
                    localStorage.setItem('karaoke_current_song', JSON.stringify(currentSong));
                    console.log('‚úÖ Current song set in localStorage (Firebase not configured):', song.title);
                } else {
                    console.log('‚úÖ Song added to queue:', song.title);
                }
            }

            // Set audio source for singer to hear preview/karaoke track
            // Note: Direct YouTube audio streaming requires special handling
            // For now, we disable audio preview to avoid errors
            if (audioPlayer && song.videoId) {
                // YouTube watch URLs are not valid audio sources
                // Audio preview would require server-side processing
                suppressAudioErrors = true;
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                audioPlayer.removeAttribute('src');
                suppressAudioErrors = false;
                console.log('üìª Audio preview disabled (YouTube videos require special handling)');
                // Singer can watch the video on TV display for playback timing
            }

            // Update Firebase if available
            if (useSingerFirebase && typeof firebase !== 'undefined' && firebase.database) {
                try {
                    const newCurrentSong = {
                        title: song.title,
                        artist: song.artist,
                        videoId: song.videoId,
                        requestedBy: song.requestedBy,
                        singer: song.requestedBy,
                        timestamp: Date.now()
                    };
                    // Note: The actual currentSong update is handled in the async Firebase check above
                    console.log('üì§ Current song updated (Firebase)');
                } catch (err) {
                    console.warn('Firebase error:', err.message);
                }
            }

            // Auto-play removed - users must manually start the TV display
            console.log('üéµ Song requested for:', song.title);
        }

        // Helper function for successful request
        function successCallback(btn, title) {
            setTimeout(() => {
                showAlert(`‚úÖ "${title}" added to Reserved Songs!`, 'success');
                document.getElementById('searchInput').value = '';
                document.getElementById('resultsContainer').innerHTML = '';
                btn.disabled = false;
                btn.textContent = '‚úì Select';
            }, 500);
        }

        // Show alert
        function showAlert(message, type = 'info') {
            const container = document.getElementById('resultsContainer');
            let alertStyle = '';

            if (type === 'success') {
                alertStyle = 'background: rgba(40, 167, 69, 0.1); border-color: rgba(40, 167, 69, 0.5); color: #28a745;';
            } else if (type === 'danger') {
                alertStyle = 'background: rgba(220, 53, 69, 0.1); border-color: rgba(220, 53, 69, 0.5); color: #dc3545;';
            }

            const alert = document.createElement('div');
            alert.className = 'alert alert-custom';
            alert.style.cssText = alertStyle;
            alert.innerHTML = message;

            const existing = container.querySelector('.alert');
            if (existing) existing.remove();

            container.insertBefore(alert, container.firstChild);

            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transition = 'opacity 0.3s ease';
                setTimeout(() => alert.remove(), 300);
            }, 3000);
        }

        // Load reserved songs
        function loadReservedSongs() {
            const stored = localStorage.getItem('karaoke_reserved_songs');
            if (stored) {
                try {
                    reservedSongs = JSON.parse(stored);
                } catch (e) {
                    reservedSongs = [];
                }
            } else {
                reservedSongs = [];
            }
        }

        // Display reserved songs
        function displayReservedSongs() {
            const container = document.getElementById('reservedSongs');
            if (!container) return;

            if (reservedSongs.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 2rem; font-style: italic;">No reserved songs yet. Search and request songs!</div>';
                return;
            }

            let html = '';
            reservedSongs.forEach((song, index) => {
                html += `
                    <div class="song-item">
                        <div style="font-weight: 600; margin-bottom: 5px;">#${index + 1} ${song.title}</div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">üé§ ${song.artist}</div>
                        <div style="font-size: 0.85rem; opacity: 0.7; margin-top: 3px;">üë§ ${song.requestedBy || 'Unknown'}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Load all songs
        function loadAllSongs() {
            allSongs = [
                { title: "Bohemian Rhapsody - Karaoke", artist: "Queen", videoId: "fJ9rUzIMt7o" },
                { title: "Hallelujah - Karaoke", artist: "Leonard Cohen", videoId: "YAHxj0k0WL0" },
                { title: "Someone Like You - Karaoke", artist: "Adele", videoId: "hHUbLv4ThOk" }
            ];
        }

        // Update user display
        function updateUserDisplay() {
            const userDisplayName = document.getElementById('userDisplayName');
            
            if (userDisplayName && loggedInUser) {
                userDisplayName.textContent = `üé§ Welcome, ${loggedInUser.username}!`;
                userDisplayName.style.color = '#f093fb';
                localStorage.setItem('karaoke_user_name', loggedInUser.username);
            }
        }

        // Reload player - restart current song on TV display
        function reloadPlayer() {
            const refreshBtn = document.querySelector('.refresh');
            
            // Add rotating animation
            if (refreshBtn) {
                refreshBtn.classList.add('rotating');
                // Remove animation after 2 seconds
                setTimeout(() => {
                    refreshBtn.classList.remove('rotating');
                }, 2000);
            }
            
            console.log('üîÑ Reload requested');
            if (useSingerFirebase && typeof firebase !== 'undefined' && firebase.database) {
                try {
                    firebase.database().ref('control').set({ command: 'restart', timestamp: Date.now() });
                    showAlert('Restarting current song on TV display', 'info');
                } catch (err) {
                    console.warn('Firebase control error:', err.message);
                    showAlert('Could not send restart command', 'warning');
                }
            } else {
                showAlert('Firebase not available - controls disabled', 'warning');
            }
        }

        // Toggle play/pause on TV display
        function togglePlayPause() {
            const btn = document.getElementById('playPauseBtn');
            console.log('‚èØÔ∏è Play/Pause toggled');
            
            if (useSingerFirebase && typeof firebase !== 'undefined' && firebase.database) {
                try {
                    firebase.database().ref('control').set({ command: 'togglePlay', timestamp: Date.now() });
                    if (btn) {
                        btn.textContent = btn.textContent === '‚ñ∂' ? '‚è∏' : '‚ñ∂';
                    }
                    showAlert('Sent play/pause command to TV display', 'info');
                } catch (err) {
                    console.warn('Firebase control error:', err.message);
                    showAlert('Could not send play/pause command', 'warning');
                }
            } else {
                showAlert('Firebase not available - controls disabled', 'warning');
            }
        }

        // Stop player - skip to next song on TV display
        function stopPlayer() {
            console.log('‚è≠Ô∏è Stop (skip) requested');
            
            if (useSingerFirebase && typeof firebase !== 'undefined' && firebase.database) {
                try {
                    firebase.database().ref('control').set({ command: 'skip', timestamp: Date.now() });
                    const btn = document.getElementById('playPauseBtn');
                    if (btn) {
                        btn.textContent = '‚ñ∂';
                    }
                    showAlert('Skipping to next song on TV display', 'info');
                } catch (err) {
                    console.warn('Firebase control error:', err.message);
                    showAlert('Could not send skip command', 'warning');
                }
            } else {
                showAlert('Firebase not available - controls disabled', 'warning');
            }
        }

        // Toggle mute on TV display
        function toggleMute() {
            const btn = document.getElementById('muteBtn');
            console.log('üîá Mute toggled');
            
            if (useSingerFirebase && typeof firebase !== 'undefined' && firebase.database) {
                try {
                    firebase.database().ref('control').set({ command: 'toggleMute', timestamp: Date.now() });
                    if (btn) {
                        btn.textContent = btn.textContent === 'üîä' ? 'üîá' : 'üîä';
                    }
                    showAlert('Sent mute/unmute command to TV display', 'info');
                } catch (err) {
                    console.warn('Firebase control error:', err.message);
                    showAlert('Could not send mute command', 'warning');
                }
            } else {
                showAlert('Firebase not available - controls disabled', 'warning');
            }
        }

        // Update singer activity
        function updateSingerActivity() {
            const singerName = localStorage.getItem('karaoke_user_name');
            if (!singerName) return;
            
            let users = [];
            const stored = localStorage.getItem('karaoke_users');
            if (stored) {
                users = JSON.parse(stored);
            }
            
            let user = users.find(u => u.username === singerName);
            if (!user) {
                user = {
                    id: users.length + 1,
                    username: singerName,
                    password: 'singer',
                    role: 'user',
                    joined: new Date().toISOString().split('T')[0],
                    lastActivity: new Date().getTime()
                };
                users.push(user);
            } else {
                user.lastActivity = new Date().getTime();
            }
            
            localStorage.setItem('karaoke_users', JSON.stringify(users));
        }
    </script>
</body>
</html>
